
<link rel="stylesheet" href="http://localhost:5984/diebruecke/_design/b2/static/jquery-ui-timepicker-addon.css">
<link rel="stylesheet" href="http://localhost:5984/diebruecke/_design/b2/static/ui-lightness/jquery-ui-1.10.4.custom.css">

<link rel="stylesheet" href="http://localhost:5984/diebruecke/_design/b2/static/select/bootstrap-select.css">

<script src="http://localhost:5984/diebruecke/_design/b2/static/jquery-ui-1.10.4.custom.js"></script>
<script src="http://localhost:5984/diebruecke/_design/b2/static/jquery-ui-timepicker-addon.js"></script>
<script src="http://localhost:5984/diebruecke/_design/b2/static/select/bootstrap-select.js"></script>

<h1>Details</h1>



<h2>{{doc.name}}</h2>

<table>
	<tr >
		<td rowspan="7">
			<div id="mainimage">
				<img width="150" heigth="200" src="{{imgbaseurl}}/{{doc.image}}">
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<label for="text">Kurztext</label>
		</td>
		<td>
			<input type="text" id="text" size="50" value="{{doc.text}}">
		</td>
	</tr>
	<tr>
		<td>
			<label for="longText">Langtext</label>
		</td>
		<td>
			<textarea id="longText" cols="50">{{doc.longText}}</textarea>
		</td>
	</tr>	
	<tr>
		<td>
			<label for="checkbox_id">sichtbar</label>
		</td>
		<td>
			<input type="Checkbox" disabled="disabled" name="sichtbar" id="checkbox_id" value="visibilty" checked="checked">
		</td>
	</tr>
	<tr>
		<td>
			<label for="freischaltepisode">freischalten:</label>
		</td>
		<td>
			<select id="freischaltepisode" class="selectpicker" data-style="btn-primary">
				{{#select doc.freischaltepisode}}
			    <option value="0">von Anfang an</option>
			    <option value="1">nach Episode 1</option>
			    <option value="2">nach Episode 2</option>
			    <option value="3">nach Episode 3</option>
			    <option value="4">nach Episode 4</option>
			    <option value="5">nach Episode 5</option>
				{{/select}}   
			  </select>
		</td>
	</tr>			
	<tr>
		<td>
			<label for="stimmen">Stimmen:</label>
		</td>
		<td>
			<input id="stimmen" type="text" value="{{doc.stimmen}}">
		</td>
	</tr>		
	</div>

<table>



<div id="relations">
Beziehungen
{{#list doc.relations}}	
	{{name}}
	<!-- slug auf freischaltwoche prüfen und anzeigen
	text übersetzt per ajax laden -->
{{/list}}
</div>


<div id="media">
	<ul class="imagelist">
		{{#list doc.media}}	
	
			<div class="zeile">
				<div class="zelle">
					<div class="{{type}}">
						<a href="{{../mediabaseurl}}/{{image}}" ><img src="{{../mediabaseurl}}/{{thumbnail}}"/></a>
					</div>
				</div>
				<div class="zelle">
					<div class="select_freischaltepisode">
						<select id="freischaltepisode" class="selectpicker" data-style="btn-primary" media-url="{{image}}">
							{{#select freischaltepisode}}
						    <option value="0">von Anfang an</option>
						    <option value="1">nach Episode 1</option>
						    <option value="2">nach Episode 2</option>
						    <option value="3">nach Episode 3</option>
						    <option value="4">nach Episode 4</option>
						    <option value="5">nach Episode 5</option>
							{{/select}}   
						  </select>			
					</div>
					<div class="tools">
						<button type="button" btn-role="delete" class="btn btn-danger">Element löschen</button>

					</div>
				</div>
			</div>
		{{/list}}
	</ul>
</div>


<div id="videoplayer">
	<button type="button" id="chosen-btn" style="display:block" class="btn btn-primary">Videodatei auswählen</button>
	<input type="file" id="chosen" style="display:none" />
	<video id="video" controls style="width: 50%;"></video>
</div>

<div id="snaphsot">

	<button id="snap" style="display:block" class="btn btn-primary" onclick="snap()">Vorschaubild erstellen</button>
	<canvas></canvas>
</div>



<div>
<button class="btn btn-primary ladda-button" data-style="zoom-in" id="save_doc"><span class="ladda-label">speichern</span></button>
</div>

<script type="text/javascript">
	var db = require('db').use("{{baseurl}}");

	var userurl = "{{baseurl}}{{doc.slug}}";

	var user = "";


	//Video und Foto Script

	// Get handles on the video and canvas elements
	var video = document.querySelector('video');
	var canvas = document.querySelector('canvas');
	// Get a handle on the 2d context of the canvas element
	var context = canvas.getContext('2d');
	// Define some vars required later
	var w, h, ratio;

	// Add a listener to wait for the 'loadedmetadata' state so the video's dimensions can be read
	video.addEventListener('loadedmetadata', function() {
		// Calculate the ratio of the video's width to height
		ratio = video.videoWidth / video.videoHeight;
		// Define the required width as 100 pixels smaller than the actual video's width
		w = video.videoWidth - 100;
		w = 734;
		// Calculate the height based on the video's width and the ratio
		h = 413;//parseInt(w / ratio, 10);
		// Set the canvas width and height to the values just calculated
		canvas.width = w;
		canvas.height = h;			
	}, false);	


	document.getElementById('chosen').onchange = function (){

		var vplayer=document.getElementById('video'); // A reference to the video-element
		var file=document.getElementById('chosen').files[0]; // 1st member in files-collection
		var fileURL = window.URL.createObjectURL(file);
		vplayer.src=fileURL;
		vplayer.load();
		return ; // A good manner to end up a function

	};
	
	// Takes a snapshot of the video
	function snap() {
		//resize ti 734x413
		// Define the size of the rectangle that will be filled (basically the entire element)
		context.fillRect(0, 0, w, h);
		// Grab the image from the video
		context.drawImage(video, 0, 0, w, h);
	}

	//Ende Video und Foto Script

	db.getDoc("{{doc.slug}}", function(err,response){
		if(err) return;
		

		user = response;

		//$('.selectpicker').selectpicker("val", user.freischaltepisode);
	});
	$('.selectpicker').selectpicker();


	$("button[btn-role='delete']").click(function( event ) {
		var file = this;
		console.log(file);
		return false;
	});

	$( "#chosen-btn" ).click(function( event ) {
		var file = document.getElementById('chosen');
		file.click();
		return false;
	});

	$( "#save_doc" ).click(function( event ) {
		event.preventDefault();		
		//animation
		var l = Ladda.create(this);
		l.start();


		//user data object
		user.text = $("#text").val();
		user.longText = $("#longText").val();
		user.freischaltepisode = $("#freischaltepisode").val();
		// user.freischaltzeit = $("#freischaltzeit").val();
		user.stimmen = $("#stimmen").val();

		//getMediaData
		$("select[media-url]").each(function( index ) {
			var mediaUrl = $( this ).attr("media-url");
			var mediaFreischaltepisode = this.value

			console.log( mediaFreischaltepisode + ": " +  mediaUrl);
			for (var i = 0; i <  user.media.length; i++) {
				if (user.media[i].image == mediaUrl)
				{	//save
					user.media[i].freischaltepisode = mediaFreischaltepisode;
				}
			};
		});

		// user.text = $("#text").val();
		db.saveDoc(user, docSaved(l));
	});

	function docSaved(l){
		return function(err, response){
			l.stop();
			if (err) return;
			
			
			if (response.ok)
				user._rev = response.rev;
		}
	}



	$('#freischaltdatum').datetimepicker({
		altField: "#freischaltzeit",
		dateFormat: "dd.mm.yy",
		timeFormat: "HH:mm",
		onSelect: function(dateText) {
			console.log($("#freischaltdatum").val());
			console.log($("#freischaltzeit").val());
		}
	});	
	


</script>